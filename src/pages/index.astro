---
import Layout from '@/components/Layout.astro';
import H1 from '@/components/sanity/H1.astro';
import H2 from '@/components/sanity/H2.astro';
import PortableText from '@/components/sanity/PortableText.astro';
import imageUrlBuilder from '@sanity/image-url';
import type { Author, Post } from 'sanity.types';
import { sanityClient } from 'sanity:client';

const authorFetch = sanityClient.fetch<Author>(
  `*[_type == "author" && slug.current == "simjes"][0]{ name, bio[0], image }`,
);

const postsFetch = sanityClient.fetch<Post[]>(
  `*[_type == "post" && publishedAt <= $now] | order(publishedAt desc) { _id, title, slug, publishedAt }`,
  { now: new Date().toISOString() },
);

const [author, posts] = await Promise.all([authorFetch, postsFetch]);

const authorImage =
  author.image &&
  imageUrlBuilder(sanityClient).image(author.image).width(900).url();
---

<Layout title='Blog'>
  <section
    class='mb-6 mt-16 flex flex-col items-center space-y-4 md:flex-row md:space-x-4 md:space-y-0'
  >
    <header>
      <H1>{author.name}</H1>
      <div class='text-xl'>
        <PortableText portableText={author.bio} />
      </div>
      <div>
        <a
          class='p-1 font-bold underline decoration-cyan-500 decoration-2 transition duration-300 ease-in-out hover:text-fuchsia-500 dark:text-white dark:hover:text-fuchsia-500'
          href='https://twitter.com/itsalwayskos'
          target='_blank'
          aria-label='Go to my twitter'
          rel='noreferrer'
        >
          @itsalwayskos
        </a>
      </div>
    </header>

    <img
      src={authorImage}
      class='h-52 w-52 rounded-full'
      alt={`Author ${author.name}`}
      height={208}
      width={208}
    />
  </section>

  <section>
    <H2>Posts</H2>
    <ol class='mt-2 space-y-2'>
      {
        posts.map((post) => {
          if (!post.publishedAt || !post.slug) {
            return '';
          }

          const date = new Date(post.publishedAt).toLocaleDateString('en-US', {
            dateStyle: 'long',
          });
          return (
            <li class='space-x-1'>
              <a
                class='underline decoration-cyan-500 decoration-2 transition duration-300 ease-in-out hover:text-fuchsia-500 dark:text-white dark:hover:text-fuchsia-500'
                href={`blog/${post.slug.current}`}
              >
                {post.title}
              </a>{' '}
              <span class='text-sm'>{date}</span>
            </li>
          );
        })
      }
    </ol>
  </section>
</Layout>
